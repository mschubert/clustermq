<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Evaluate Function Calls on HPC Schedulers (LSF, SGE, SLURM, PBS/Torque) • clustermq</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Evaluate Function Calls on HPC Schedulers (LSF, SGE, SLURM, PBS/Torque)">
<meta property="og:description" content="Evaluate arbitrary function calls using workers on HPC schedulers
    in single line of code. All processing is done on the network without
    accessing the file system. Remote schedulers are supported via SSH.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">clustermq</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.8.95.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home"></span>
     
  </a>
</li>
<li>
  <a href="articles/userguide.html">User Guide</a>
</li>
<li>
  <a href="articles/technicaldocs.html">Technical Documentation</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mschubert/clustermq">
    <span class="fas fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="clustermq-send-r-function-calls-as-cluster-jobs" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#clustermq-send-r-function-calls-as-cluster-jobs" class="anchor"></a>ClusterMQ: send R function calls as cluster jobs</h1></div>

<p>This package will allow you to send function calls as jobs on a computing cluster with a minimal interface provided by the <code>Q</code> function:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># load the library and create a simple function</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mschubert.github.io/clustermq/">clustermq</a></span><span class="op">)</span>
<span class="va">fx</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">*</span> <span class="fl">2</span>

<span class="co"># queue the function call on your scheduler</span>
<span class="fu"><a href="reference/Q.html">Q</a></span><span class="op">(</span><span class="va">fx</span>, x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, n_jobs<span class="op">=</span><span class="fl">1</span><span class="op">)</span>
<span class="co"># list(2,4,6)</span></code></pre></div>
<p>Computations are done <a href="https://zeromq.org/">entirely on the network</a> and without any temporary files on network-mounted storage, so there is no strain on the file system apart from starting up R once per job. All calculations are load-balanced, i.e. workers that get their jobs done faster will also receive more function calls to work on. This is especially useful if not all calls return after the same time, or one worker has a high load.</p>
<p>Browse the vignettes here:</p>
<ul>
<li><a href="https://mschubert.github.io/clustermq/articles/userguide.html">User Guide</a></li>
<li><a href="https://mschubert.github.io/clustermq/articles/technicaldocs.html">Technical Documentation</a></li>
</ul>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>First, we need the <a href="https://github.com/zeromq/libzmq">ZeroMQ</a> system library. This is probably already installed on your system. If not, your package manager will provide it:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># You can skip this step on Windows and macOS, the package binary has it</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># On a computing cluster, we recommend to use Conda or Linuxbrew</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install zeromq # Linuxbrew, Homebrew on macOS</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">conda</span> install zeromq # Conda, Miniconda</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install libzmq3-dev <span class="co"># Ubuntu</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> yum install zeromq-devel <span class="co"># Fedora</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="ex">pacman</span> -S zeromq # Arch Linux</span></code></pre></div>
<p>Then install the <code>clustermq</code> package in R from CRAN:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'clustermq'</span><span class="op">)</span></code></pre></div>
<p>Alternatively you can use the <code>remotes</code> package to install directly from Github:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># install.packages('remotes')</span>
<span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">'mschubert/clustermq'</span><span class="op">)</span>
<span class="co"># remotes::install_github('mschubert/clustermq', ref="develop") # dev version</span></code></pre></div>
</div>
<div id="schedulers" class="section level2">
<h2 class="hasAnchor">
<a href="#schedulers" class="anchor"></a>Schedulers</h2>
<p>An HPC cluster’s scheduler ensures that computing jobs are distributed to available worker nodes. Hence, this is what clustermq interfaces with in order to do computations.</p>
<p>We currently support the <a href="https://mschubert.github.io/clustermq/articles/userguide.html#configuration">following schedulers</a> (either locally or via SSH):</p>
<ul>
<li>
<a href="https://mschubert.github.io/clustermq/articles/userguide.html#local-parallelization">Multiprocess</a> - <em>test your calls and parallelize on cores using</em> <code><a href="https://rdrr.io/r/base/options.html">options(clustermq.scheduler="multiprocess")</a></code>
</li>
<li>
<a href="https://mschubert.github.io/clustermq/articles/userguide.html#lsf">LSF</a> - <em>should work without setup</em>
</li>
<li>
<a href="https://mschubert.github.io/clustermq/articles/userguide.html#sge">SGE</a> - <em>should work without setup</em>
</li>
<li>
<a href="https://mschubert.github.io/clustermq/articles/userguide.html#slurm">SLURM</a> - <em>should work without setup</em>
</li>
<li>
<a href="https://mschubert.github.io/clustermq/articles/userguide.html#pbs">PBS</a>/<a href="https://mschubert.github.io/clustermq/articles/userguide.html#torque">Torque</a> - <em>needs</em> <code><a href="https://rdrr.io/r/base/options.html">options(clustermq.scheduler="PBS"/"Torque")</a></code>
</li>
<li>via <a href="https://mschubert.github.io/clustermq/articles/userguide.html#ssh-connector">SSH</a> - <em>needs</em> <code>options(clustermq.scheduler="ssh", clustermq.ssh.host=&lt;yourhost&gt;)</code>
</li>
</ul>
<p>Default submission templates <a href="https://github.com/mschubert/clustermq/tree/master/inst">are provided</a> and <a href="https://mschubert.github.io/clustermq/articles/userguide.html#configuration">can be customized</a>, e.g. to activate <a href="https://mschubert.github.io/clustermq/articles/userguide.html#environments">compute environments or containers</a>.</p>
</div>
<div id="usage" class="section level2">
<h2 class="hasAnchor">
<a href="#usage" class="anchor"></a>Usage</h2>
<p>The most common arguments for <code>Q</code> are:</p>
<ul>
<li>
<code>fun</code> - The function to call. This needs to be self-sufficient (because it will not have access to the <code>master</code> environment)</li>
<li>
<code>...</code> - All iterated arguments passed to the function. If there is more than one, all of them need to be named</li>
<li>
<code>const</code> - A named list of non-iterated arguments passed to <code>fun</code>
</li>
<li>
<code>export</code> - A named list of objects to export to the worker environment</li>
</ul>
<p>The documentation for other arguments can be accessed by typing <code><a href="reference/Q.html">?Q</a></code>. Examples of using <code>const</code> and <code>export</code> would be:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># adding a constant argument</span>
<span class="va">fx</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="va">x</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">+</span> <span class="va">y</span>
<span class="fu"><a href="reference/Q.html">Q</a></span><span class="op">(</span><span class="va">fx</span>, x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, const<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, n_jobs<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># exporting an object to workers</span>
<span class="va">fx</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">*</span> <span class="fl">2</span> <span class="op">+</span> <span class="va">y</span>
<span class="fu"><a href="reference/Q.html">Q</a></span><span class="op">(</span><span class="va">fx</span>, x<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, export<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>y<span class="op">=</span><span class="fl">10</span><span class="op">)</span>, n_jobs<span class="op">=</span><span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><code>clustermq</code> can also be used as a parallel backend for <a href="https://cran.r-project.org/package=foreach"><code>foreach</code></a>. As this is also used by <a href="http://bioconductor.org/packages/release/bioc/html/BiocParallel.html"><code>BiocParallel</code></a>, we can run those packages on the cluster as well:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RevolutionAnalytics/foreach">foreach</a></span><span class="op">)</span>
<span class="fu"><a href="reference/register_dopar_cmq.html">register_dopar_cmq</a></span><span class="op">(</span>n_jobs<span class="op">=</span><span class="fl">2</span>, memory<span class="op">=</span><span class="fl">1024</span><span class="op">)</span> <span class="co"># see `?workers` for arguments</span>
<span class="fu"><a href="https://rdrr.io/pkg/foreach/man/foreach.html">foreach</a></span><span class="op">(</span>i<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span> <span class="op">%dopar%</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="co"># this will be executed as jobs</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/Bioconductor/BiocParallel">BiocParallel</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/register.html">register</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/DoparParam-class.html">DoparParam</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># after register_dopar_cmq(...)</span>
<span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/bplapply.html">bplapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="va">sqrt</span><span class="op">)</span></code></pre></div>
<p>More examples are available in <a href="https://mschubert.github.io/clustermq/articles/userguide.html">the user guide</a>.</p>
</div>
<div id="comparison-to-other-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#comparison-to-other-packages" class="anchor"></a>Comparison to other packages</h2>
<p>There are some packages that provide high-level parallelization of R function calls on a computing cluster. We compared <code>clustermq</code> to <code>BatchJobs</code> and <code>batchtools</code> for processing many short-running jobs, and found it to have approximately 1000x less overhead cost.</p>
<p><img src="http://image.ibb.co/cRgYNR/plot.png" alt="Overhead comparison"></p>
<p>In short, use <code>clustermq</code> if you want:</p>
<ul>
<li>a one-line solution to run cluster jobs with minimal setup</li>
<li>access cluster functions from your local Rstudio via SSH</li>
<li>fast processing of many function calls without network storage I/O</li>
</ul>
<p>Use <a href="https://github.com/mllg/batchtools"><code>batchtools</code></a> if you:</p>
<ul>
<li>want to use a mature and well-tested package</li>
<li>don’t mind that arguments to every call are written to/read from disc</li>
<li>don’t mind there’s no load-balancing at run-time</li>
</ul>
<p>Use <a href="https://snakemake.readthedocs.io/en/latest/">Snakemake</a> or <a href="https://github.com/ropensci/drake"><code>drake</code></a> if:</p>
<ul>
<li>you want to design and run a workflow on HPC</li>
</ul>
<p>Don’t use <a href="https://cran.r-project.org/web/packages/batch/index.html"><code>batch</code></a> (last updated 2013) or <a href="https://github.com/tudo-r/BatchJobs"><code>BatchJobs</code></a> (issues with SQLite on network-mounted storage).</p>
</div>
<div id="contributing" class="section level2">
<h2 class="hasAnchor">
<a href="#contributing" class="anchor"></a>Contributing</h2>
<p>We use Github’s <a href="https://github.com/mschubert/clustermq/issues">Issue Tracker</a> to coordinate development of <code>clustermq</code>. Contributions are welcome and they come in many different forms, shapes, and sizes. These include, but are not limited to:</p>
<ul>
<li>Questions: You are welcome to ask questions if something is not clear in the <a href="https://mschubert.github.io/clustermq/articles/userguide.html">User guide</a>.</li>
<li>Bug reports: Let us know if something does not work as expected. Be sure to include a self-contained <a href="https://stackoverflow.com/help/minimal-reproducible-example">Minimal Reproducible Example</a> and set <code>log_worker=TRUE</code>.</li>
<li>Code contributions: Have a look at the <a href="https://github.com/mschubert/clustermq/issues?q=is%3Aissue+is%3Aopen+label%3A%22good+first+issue%22"><code>good first   issue</code></a> tag. Please discuss anything more complicated before putting a lot of work in, I’m happy to help you get started.</li>
</ul>
</div>
<div id="citation" class="section level2">
<h2 class="hasAnchor">
<a href="#citation" class="anchor"></a>Citation</h2>
<p>This project is part of my academic work, for which I will be evaluated on citations. If you like me to be able to continue working on research support tools like <code>clustermq</code>, please cite the article when using it for publications:</p>
<blockquote>
<p>M Schubert. clustermq enables efficient parallelisation of genomic analyses. <em>Bioinformatics</em> (2019). <a href="https://doi.org/10.1093/bioinformatics/btz284">doi:10.1093/bioinformatics/btz284</a></p>
</blockquote>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=clustermq">https://​cloud.r-project.org/​package=clustermq</a>
</li>
<li>Browse source code at <br><a href="https://github.com/mschubert/clustermq/">https://​github.com/​mschubert/​clustermq/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/mschubert/clustermq/issues">https://​github.com/​mschubert/​clustermq/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>Apache License (== 2.0) | file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>
<div class="citation">
<h2>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html">Citing clustermq</a></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Michael Schubert <br><small class="roles"> Author, maintainer </small> <a href="https://orcid.org/0000-0002-6862-5221" target="orcid.widget" aria-label="ORCID"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://cran.r-project.org/package=clustermq"><img src="http://www.r-pkg.org/badges/version/clustermq" alt="CRAN version"></a></li>
<li><a href="https://github.com/mschubert/clustermq/actions"><img src="https://github.com/mschubert/clustermq/workflows/R-CMD-check/badge.svg?branch=master" alt="Build Status"></a></li>
<li><a href="http://cran.rstudio.com/web/packages/clustermq/index.html"><img src="http://cranlogs.r-pkg.org/badges/clustermq" alt="CRAN downloads"></a></li>
<li><a href="https://doi.org/10.1093/bioinformatics/btz284"><img src="https://zenodo.org/badge/DOI/10.1093/bioinformatics/btz284.svg" alt="DOI"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Michael Schubert.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
