<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Technical Documentation • clustermq</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Technical Documentation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">clustermq</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span></a></li>
<li class="nav-item"><a class="nav-link" href="../articles/userguide.html">User Guide</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/technicaldocs.html">Technical Documentation</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/faq.html">FAQ</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/mschubert/clustermq"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Technical Documentation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mschubert/clustermq/blob/HEAD/vignettes/technicaldocs.Rmd" class="external-link"><code>vignettes/technicaldocs.Rmd</code></a></small>
      <div class="d-none name"><code>technicaldocs.Rmd</code></div>
    </div>

    
    
<style type="text/css">
img {
    border: 0px !important;
    margin: 2em 2em 2em 2em !important;
}
code {
    border: 0px !important;
}
</style>
<div class="section level2">
<h2 id="worker-api">Worker API<a class="anchor" aria-label="anchor" href="#worker-api"></a>
</h2>
<div class="section level3">
<h3 id="base-api-and-schedulers">Base API and schedulers<a class="anchor" aria-label="anchor" href="#base-api-and-schedulers"></a>
</h3>
<p>The main worker functions are wrapped in an <em>R6</em> class with
the name of <code>QSys</code>. This provides a standardized API to the
<a href="https://mschubert.github.io/clustermq/articles/technicaldocs.html#zeromq-message-specification" class="external-link">lower-level
messages</a> that are sent via <a href="https://zeromq.org/" class="external-link"><em>ZeroMQ</em></a>.</p>
<p>The base class itself is derived in scheduler classes that add the
required functions for submitting and cleaning up jobs:</p>
<pre><code>+ QSys
  |- Multicore
  |- LSF
  + SGE
    |- PBS
    |- Torque
  |- etc.</code></pre>
<p>The user-visible object is a worker <code>Pool</code> that wraps
this, and will eventually allow to manage different workers.</p>
</div>
<div class="section level3">
<h3 id="workers">Workers<a class="anchor" aria-label="anchor" href="#workers"></a>
</h3>
<div class="section level4">
<h4 id="creating-a-worker-pool">Creating a worker pool<a class="anchor" aria-label="anchor" href="#creating-a-worker-pool"></a>
</h4>
<p>A pool of workers can be created using the <code><a href="../reference/workers.html">workers()</a></code>
function, which instantiates a <code>Pool</code> object of the
corresponding <code>QSys</code>-derived scheduler class. See
<code><a href="../reference/workers.html">?workers</a></code> for details.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># start up a pool of three workers using the default scheduler</span></span>
<span><span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="../reference/workers.html">workers</a></span><span class="op">(</span>n_jobs<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># if we make an unclean exit for whatever reason, clean up the jobs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="va">w</span><span class="op">$</span><span class="fu">cleanup</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="worker-startup">Worker startup<a class="anchor" aria-label="anchor" href="#worker-startup"></a>
</h4>
<p>For workers that are started up via a scheduler, we do not know which
machine they will run on. This is why we start up every worker with a
TCP/IP address of the master socket that will distribute work.</p>
<p>This is achieved by the call to R common to all schedulers:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">R</span> <span class="at">--no-save</span> <span class="at">--no-restore</span> <span class="at">-e</span> <span class="st">'clustermq:::worker("{{ master }}")'</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="worker-communication">Worker communication<a class="anchor" aria-label="anchor" href="#worker-communication"></a>
</h4>
<p>On the master’s side, we wait until a worker connects:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">msg</span> <span class="op">=</span> <span class="va">w</span><span class="op">$</span><span class="fu">recv</span><span class="op">(</span><span class="op">)</span> <span class="co"># this will block until a worker is ready</span></span></code></pre></div>
<p>We can then send any expression to be evaluated on the worker using
the <code>send</code> method:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="va">expression</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p>After the expression (in <code>...</code>), any variables that should
be passed along with the call can be added. For batch processing that
<code>clustermq</code> usually does, this command is
<code>work_chunk</code>, where the <code>chunk</code> data is added:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w</span><span class="op">$</span><span class="fu">send</span><span class="op">(</span><span class="fu">clustermq</span><span class="fu">:::</span><span class="fu"><a href="../reference/work_chunk.html">work_chunk</a></span><span class="op">(</span><span class="va">chunk</span>, <span class="va">fun</span>, <span class="va">const</span>, <span class="va">rettype</span>, <span class="va">common_seed</span><span class="op">)</span>,</span>
<span>       chunk <span class="op">=</span> <span class="fu"><a href="../reference/chunk.html">chunk</a></span><span class="op">(</span><span class="va">iter</span>, <span class="va">submit_index</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="worker-environment">Worker environment<a class="anchor" aria-label="anchor" href="#worker-environment"></a>
</h4>
<p>We can add any number of objects to a worker environment using the
<code>env</code> method:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w</span><span class="op">$</span><span class="fu">env</span><span class="op">(</span>object<span class="op">=</span><span class="va">value</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
<p>This will also invisibly return a <code>data.frame</code> with all
objects currently in the environment. If a user wants to inspect the
environment without changing it they can call <code>w$env()</code>
without arguments. The environment will be propagated to all workers
automatically in a greedy fashion.</p>
</div>
</div>
<div class="section level3">
<h3 id="main-event-loop">Main event loop<a class="anchor" aria-label="anchor" href="#main-event-loop"></a>
</h3>
<p>Putting the above together in an event loop, we get what is
essentially implemented in <code>master</code>. <code>w$send</code>
invisibly returns an identifier to track which call was submitted, and
<code>w$current()</code> matches the same to <code>w$recv()</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>w <span class="ot">=</span> <span class="fu">workers</span>(<span class="dv">3</span>)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="fu">on.exit</span>(w<span class="sc">$</span><span class="fu">cleanup</span>())</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>w<span class="sc">$</span><span class="fu">env</span>(...)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="cf">while</span> (we have new work to send <span class="sc">||</span> jobs pending) {</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    res <span class="ot">=</span> w<span class="sc">$</span><span class="fu">recv</span>() <span class="co"># the result of the call, or NULL for a new worker</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    w<span class="sc">$</span><span class="fu">current</span>()<span class="sc">$</span>call_ref <span class="co"># matches answer to request, -1 otherwise</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>    <span class="co"># handle result</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    <span class="cf">if</span> (more work)</span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>        call_ref <span class="ot">=</span> w<span class="sc">$</span><span class="fu">send</span>(expression, ...) <span class="co"># call_ref tracks request identity</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>        w<span class="sc">$</span><span class="fu">send_shutdown</span>()</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>}</span></code></pre></div>
<p>A loop of a similar structure can be used to extend
<code>clustermq</code>. As an example, <a href="https://github.com/ropensci/targets/blob/1.2.2/R/class_clustermq.R" class="external-link">this
was done by the <em>targets</em> package</a>.</p>
</div>
</div>
<div class="section level2">
<h2 id="zeromq-message-specification">ZeroMQ message specification<a class="anchor" aria-label="anchor" href="#zeromq-message-specification"></a>
</h2>
<p>Communication between the <code>master</code> (main event loop) and
workers (<code>QSys</code> base class) is organised in
<em>messages</em>. These are chunks of serialized data sent via
<em>ZeroMQ</em>’s protocol (<em>ZMTP</em>). The parts of each message
are called <em>frames</em>.</p>
<div class="section level3">
<h3 id="master---worker-communication">Master - Worker communication<a class="anchor" aria-label="anchor" href="#master---worker-communication"></a>
</h3>
<p>The master requests an evaluation in a message with X frames (direct)
or Y if proxied. This is all handled by <em>clustermq</em>
internally.</p>
<ul>
<li>The worker identity frame or routing identifier</li>
<li>A delimiter frame</li>
<li>Worker status (<code>wlife_t</code>)</li>
<li>The call to be evaluated</li>
<li>
<em>N</em> repetitions of:
<ul>
<li>The variable name of an environment object that is not yet present
on the worker</li>
<li>The variable value</li>
</ul>
</li>
</ul>
<p>If using a proxy, this will be followed by a <code>SEXP</code> that
contains variable names the proxy should add before forwarding to the
worker.</p>
</div>
<div class="section level3">
<h3 id="worker-evaluation">Worker evaluation<a class="anchor" aria-label="anchor" href="#worker-evaluation"></a>
</h3>
<p>A worker evaluates the call using the R C API:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="fu">R_tryEvalSilent</span>(cmd, env, <span class="sc">&amp;</span>err);</span></code></pre></div>
<p>If an error occurs in this evaluation will be returned as a structure
with class <code>worker_error</code>. If a developer wants to catch
errors and warnings in a more fine-grained manner, it is recommended to
add their own <code>callingHandlers</code> to <code>cmd</code> (as
<em>clustermq</em> does work its <code>work_chunk</code>).</p>
</div>
<div class="section level3">
<h3 id="worker---master-communication">Worker - Master communication<a class="anchor" aria-label="anchor" href="#worker---master-communication"></a>
</h3>
<p>The result of this evaluation is then returned in a message with four
(direct) or five (proxied) frames:</p>
<ul>
<li>Worker identity frame (handled internally by <em>ZeroMQ</em>’s
<code>ZMQ_REQ</code> socket)</li>
<li>Empty frame (handled internally by <em>ZeroMQ</em>’s
<code>ZMQ_REQ</code> socket)</li>
<li>Worker status (<code>wlife_t</code>) that is handled internally by
<em>clustermq</em>
</li>
<li>The result of the call (<code>SEXP</code>), visible to the user</li>
</ul>
<p>If using a worker via SSH, these frames will be preceded by a routing
identify frame that is handled internally by <em>ZeroMQ</em> and added
or peeled off by the proxy.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Michael Schubert, ZeroMQ authors.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
