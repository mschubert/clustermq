<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Technical Documentation • clustermq</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Technical Documentation">
<meta property="og:description" content="clustermq">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">clustermq</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.8.96</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/userguide.html">User Guide</a>
</li>
<li>
  <a href="../articles/technicaldocs.html">Technical Documentation</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mschubert/clustermq" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Technical Documentation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mschubert/clustermq/blob/HEAD/vignettes/technicaldocs.Rmd" class="external-link"><code>vignettes/technicaldocs.Rmd</code></a></small>
      <div class="hidden name"><code>technicaldocs.Rmd</code></div>

    </div>

    
    
<style type="text/css">
img {
    border: 0px !important;
    margin: 2em 2em 2em 2em !important;
}
code {
    border: 0px !important;
}
</style>
<div class="section level2">
<h2 id="worker-api">Worker API<a class="anchor" aria-label="anchor" href="#worker-api"></a>
</h2>
<div class="section level3">
<h3 id="base-api-and-schedulers">Base API and schedulers<a class="anchor" aria-label="anchor" href="#base-api-and-schedulers"></a>
</h3>
<p>The main worker functions are wrapped in an <code>R6</code> class with the name of <code>QSys</code>. This provides a standardized API to the <a href="https://mschubert.github.io/clustermq/articles/technicaldocs.html#zeromq-message-specification" class="external-link">lower-level messages</a> that are sent via <a href="https://zeromq.org/" class="external-link"><code>ZeroMQ</code></a>.</p>
<p>The base class itself is derived in scheduler classes that add the required functions for submitting and cleaning up jobs:</p>
<pre><code>+ QSys
  |- Multicore
  |- LSF
  + SGE
    |- PBS
    |- Torque
  |- etc.</code></pre>
<p>A pool of workers can be created using the <code><a href="../reference/workers.html">workers()</a></code> function, which instantiates an object of the corresponding <code>QSys</code>-derived scheduler class. See <code><a href="../reference/workers.html">?workers</a></code> for details.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># start up a pool of three workers using the default scheduler</span>
<span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="../reference/workers.html">workers</a></span><span class="op">(</span>n_jobs<span class="op">=</span><span class="fl">3</span><span class="op">)</span>

<span class="co"># if we make an unclean exit for whatever reason, clean up the jobs</span>
<span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="va">w</span><span class="op">$</span><span class="fu">finalize</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="worker-startup">Worker startup<a class="anchor" aria-label="anchor" href="#worker-startup"></a>
</h3>
<p>For workers that are started up via a scheduler, we do not know which machine they will run on. This is why we start up every worker with a TCP/IP address of the master socket that will distribute work.</p>
<p>This is achieved by the call to R common to all schedulers:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> <span class="at">--no-save</span> <span class="at">--no-restore</span> <span class="at">-e</span> <span class="st">'clustermq:::worker("{{ master }}")'</span></span></code></pre></div>
<p>On the master’s side, we wait until a worker connects:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># this will block until a worker is ready</span>
<span class="va">msg</span> <span class="op">=</span> <span class="va">w</span><span class="op">$</span><span class="fu">receive_data</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="common-data-and-exports">Common data and exports<a class="anchor" aria-label="anchor" href="#common-data-and-exports"></a>
</h3>
<p>Workers will start up without any knowledge of what they should process or how. In order to transfer initial data to the worker, we first create and serialize a list object with the following fields:</p>
<ul>
<li>
<code>fun</code> - the function to call with iterated data</li>
<li>
<code>const</code> - the constant data each function call should receive</li>
<li>
<code>export</code> - objects that will be exported to the workers’ <code>.GlobalEnv</code>
</li>
<li>
<code>rettype</code> - character string which data type to return; e.g. <code>list</code>, <code>logical</code>
</li>
<li>
<code>common_seed</code> - random seed for function calls; will be offset by job ID</li>
<li>
<code>token</code> - character string to identify this data set; this is optional, if an automatically generated token will be returned if none is given</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create a reusable, serialized ZeroMQ object with the common data on the master</span>
<span class="va">w</span><span class="op">$</span><span class="fu">set_common_data</span><span class="op">(</span><span class="va">fun</span>, <span class="va">const</span>, <span class="va">export</span>, <span class="va">rettype</span>, <span class="va">common_seed</span>, <span class="va">token</span><span class="op">)</span></code></pre></div>
<p>Workers that connect to the master will send a list with a field <code>token</code>. This can be used to check if the worker already received the common data it is supposed to work on.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (msg<span class="sc">$</span>token <span class="sc">!=</span> <span class="er">&lt;</span>token<span class="sc">&gt;</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    w<span class="sc">$</span><span class="fu">send_common_data</span>()</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="iterated-data">Iterated data<a class="anchor" aria-label="anchor" href="#iterated-data"></a>
</h3>
<p>If the worker has already received the common data, we can send it a chunk of iterated arguments to work on. These are passed as a list of iterables, e.g. a <code>data.frame</code> with a column for each iterated argument.</p>
<p>It also needs to have a column with name <code>&lt;space&gt;id&lt;space&gt;</code>, which will be used to identify each call.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">chunk</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>arg1<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, arg2<span class="op">=</span><span class="fl">5</span><span class="op">:</span><span class="fl">1</span>, ` id `<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>
<span class="va">w</span><span class="op">$</span><span class="fu">send_job_data</span><span class="op">(</span><span class="va">chunk</span><span class="op">)</span></code></pre></div>
<p>If the worker has finished processing, it will send a message with the field <code>result</code> that is a list, containing:</p>
<ul>
<li>
<code>result</code> - a named rettype with results</li>
<li>
<code>warnings</code> - a list with warning messages of individual calls</li>
<li>
<code>errors</code> - a list with error messages of individual calls</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">msg</span> <span class="op">=</span> <span class="va">w</span><span class="op">$</span><span class="fu">receive_data</span><span class="op">(</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">msg</span><span class="op">$</span><span class="va">result</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># store result here, handle errors/warnings if required</span>
<span class="op">}</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="custom-calls">Custom calls<a class="anchor" aria-label="anchor" href="#custom-calls"></a>
</h3>
<p>Apart from sending common and iterated data that the worker will process in chunks, it is also possible to send arbitrary calls that it will evaluate. It needs the following fields:</p>
<ul>
<li>
<code>expr</code> - the expression to be evaluated</li>
<li>
<code>env</code> - list with all additional objects required to perform the call</li>
<li>
<code>ref</code> - an identifier for the call; will default to the expression itself</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w</span><span class="op">$</span><span class="fu">send_call</span><span class="op">(</span><span class="va">expr</span>, env<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>, ref<span class="op">=</span><span class="st">"mycall1"</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="main-event-loop">Main event loop<a class="anchor" aria-label="anchor" href="#main-event-loop"></a>
</h3>
<p>Putting the above together in an event loop, we get what is essentially implemented in <code>master</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>w <span class="ot">=</span> <span class="fu">workers</span>(<span class="dv">3</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">on.exit</span>(w<span class="sc">$</span><span class="fu">finalize</span>())</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> (we have new work to send) {</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    msg <span class="ot">=</span> w<span class="sc">$</span><span class="fu">receive_data</span>()</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(msg<span class="sc">$</span>result))</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># handle result</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (msg<span class="sc">$</span>token <span class="sc">!=</span> <span class="er">&lt;</span>token<span class="sc">&gt;</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        w<span class="sc">$</span><span class="fu">send_common_data</span>()</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        w<span class="sc">$</span><span class="fu">send_job_data</span>(...)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="co"># if proper cleanup is successful, cancel kill-on-exit</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (w<span class="sc">$</span><span class="fu">cleanup</span>())</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">on.exit</span>()</span></code></pre></div>
<p>A loop of a similar structure can be used to extend <code>clustermq</code>. As an example, <a href="https://github.com/ropensci/drake/blob/v7.9.0/R/backend_clustermq.R" class="external-link">this was done by <code>drake</code></a> using common data and custom calls only (no iterated chunks).</p>
</div>
</div>
<div class="section level2">
<h2 id="zeromq-message-specification">ZeroMQ message specification<a class="anchor" aria-label="anchor" href="#zeromq-message-specification"></a>
</h2>
<p>Communication between the <code>master</code> (main event loop) and workers (<code>QSys</code> base class) is organised in <em>messages</em>. These are chunks of serialized data with an <code>id</code> field, and other data that is required for this type of message.</p>
<div class="section level3">
<h3 id="messages-per-type">Messages per type<a class="anchor" aria-label="anchor" href="#messages-per-type"></a>
</h3>
<p>Below, the message <code>id</code> is listed with the additional fields per message.</p>
<div class="section level4">
<h4 id="worker">Worker<a class="anchor" aria-label="anchor" href="#worker"></a>
</h4>
<p>This workflow is handled by the <code><a href="../reference/worker.html">worker()</a></code> event loop of <code>clustermq</code> (not to be confused with the <code><a href="../reference/workers.html">workers()</a></code> control). It is the function called in every job or thread to interact with the <code><a href="../reference/master.html">master()</a></code>. The event loop is internal, i.e. it is not modifiable and not exported.</p>
<div class="section level5">
<h5 id="worker_up">
<code>WORKER_UP</code><a class="anchor" aria-label="anchor" href="#worker_up"></a>
</h5>
<ul>
<li>Message ID indicating worker is accepting data</li>
<li>Field has to be <code>worker_id</code> to master or empty to ssh_proxy</li>
<li>Answer is serialized common data (<code>fun</code>, <code>const</code>, and <code>seed</code>) or <code>redirect</code> (with URL where worker can get data)</li>
</ul>
</div>
<div class="section level5">
<h5 id="worker_ready">
<code>WORKER_READY</code><a class="anchor" aria-label="anchor" href="#worker_ready"></a>
</h5>
<ul>
<li>Message ID indicating worker is accepting chunks</li>
<li>It may contain the field <code>result</code> with a finished chunk</li>
<li>If processing failed, <code>result</code> is an object of type <code>error</code>
</li>
<li>If success, <code>result</code> is a list with the following vectors:
<ul>
<li>
<code>result</code> is a named <code>rettype</code> with results</li>
<li>
<code>warnings</code> is a list with warning messages of individual calls</li>
<li>
<code>errors</code> is a list with error messages of individual calls</li>
</ul>
</li>
</ul>
</div>
<div class="section level5">
<h5 id="worker_done">
<code>WORKER_DONE</code><a class="anchor" aria-label="anchor" href="#worker_done"></a>
</h5>
<ul>
<li>Message ID indicating worker is shutting down</li>
<li>Worker will send this in response to <code>WORKER_STOP</code>
</li>
<li>Field has to be <code>time</code> (from <code><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time()</a></code>), <code>mem</code> (max memory used) and <code>calls</code> (number of processed calls)</li>
</ul>
</div>
<div class="section level5">
<h5 id="worker_error">
<code>WORKER_ERROR</code><a class="anchor" aria-label="anchor" href="#worker_error"></a>
</h5>
<ul>
<li>Some error occurred in processing flow (not the function calls themselves)</li>
<li>Field <code>msg</code> is describing the error</li>
<li>Master will shut down after receiving this signal</li>
</ul>
</div>
</div>
<div class="section level4">
<h4 id="master">Master<a class="anchor" aria-label="anchor" href="#master"></a>
</h4>
<p>This workflow is handled by the <code><a href="../reference/master.html">master()</a></code> function of <code>clustermq</code>. If you are using <code><a href="../reference/Q.html">Q()</a></code> or <code><a href="../reference/Q_rows.html">Q_rows()</a></code>, this is handled under the hood. Workers created outside of these functions can be reused within <code><a href="../reference/Q.html">Q()</a></code>/<code><a href="../reference/Q_rows.html">Q_rows()</a></code> without knowing any of the internal message structure.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w</span> <span class="op">=</span> <span class="fu"><a href="../reference/workers.html">workers</a></span><span class="op">(</span><span class="va">n_jobs</span>, <span class="va">...</span><span class="op">)</span>
<span class="co"># w$cleanup() for a clean shutdown at the end</span></code></pre></div>
<p>The documentation below is to show it is possible to implement a custom control flow, e.g. if you want to evaluate arbitrary expressions on workers instead of defining one function to call and different arguments.</p>
<div class="section level5">
<h5 id="do_setup">
<code>DO_SETUP</code><a class="anchor" aria-label="anchor" href="#do_setup"></a>
</h5>
<ul>
<li>Message contains common data, like the function to call and its arguments</li>
<li>Required fields are: <code>fun</code>, <code>const</code>, <code>export</code>, <code>rettype</code>, <code>common_seed</code>, <code>token</code>
</li>
<li>Worker will respond with <code>WORKER_READY</code>
</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create a reusable, serialized ZeroMQ object with the common data on the master</span>
<span class="va">w</span><span class="op">$</span><span class="fu">set_common_data</span><span class="op">(</span><span class="op">)</span>
<span class="co"># send this object to a worker</span>
<span class="va">w</span><span class="op">$</span><span class="fu">send_common_data</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level5">
<h5 id="do_chunk">
<code>DO_CHUNK</code><a class="anchor" aria-label="anchor" href="#do_chunk"></a>
</h5>
<ul>
<li>Chunk of iterated arguments for the worker</li>
<li>Field has to be <code>chunk</code>, a <code>data.frame</code> where each row is a call and columns are arguments</li>
<li>Row names of <code>chunk</code> are used as call IDs</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w</span><span class="op">$</span><span class="fu">send_job_data</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level5">
<h5 id="do_call-new-in-0-8-5">
<code>DO_CALL</code> (new in <code>0.8.5</code>)<a class="anchor" aria-label="anchor" href="#do_call-new-in-0-8-5"></a>
</h5>
<ul>
<li>Evaluate a specific expression on the worker</li>
<li>Needs fields <code>expr</code> (the expression to be evaluated) and <code>env</code> (list environment to evaluate it in)</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w</span><span class="op">$</span><span class="fu">send_call</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level5">
<h5 id="worker_wait">
<code>WORKER_WAIT</code><a class="anchor" aria-label="anchor" href="#worker_wait"></a>
</h5>
<ul>
<li>Instruct the worker to wait <code>wait</code> seconds</li>
<li>Worker will respond with <code>WORKER_READY</code>
</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w</span><span class="op">$</span><span class="fu">send_wait</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level5">
<h5 id="worker_stop">
<code>WORKER_STOP</code><a class="anchor" aria-label="anchor" href="#worker_stop"></a>
</h5>
<ul>
<li>Instruct the worker to exit its main event loop</li>
<li>This message has no fields</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w</span><span class="op">$</span><span class="fu">send_shutdown_worker</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level5">
<h5 id="disconnect-and-reset-socket-state">Disconnect and reset socket state<a class="anchor" aria-label="anchor" href="#disconnect-and-reset-socket-state"></a>
</h5>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w</span><span class="op">$</span><span class="fu">disconnect_worker</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="control-flow-stages">Control flow stages<a class="anchor" aria-label="anchor" href="#control-flow-stages"></a>
</h3>
<p>The convention here is</p>
<ul>
<li>worker &gt; master
<ul>
<li>master &gt; worker</li>
</ul>
</li>
</ul>
<div class="section level4">
<h4 id="batch-processing-no-proxy">Batch processing, no proxy<a class="anchor" aria-label="anchor" href="#batch-processing-no-proxy"></a>
</h4>
<p>This is the default use case for <code>Q</code>, <code>Q_rows</code>. It will set the common data (<code>DO_SETUP</code>; function to call, constant arguments, exported data, random seed) once and then provide chunks of arguments (<code>DO_CHUNK</code>) as <code>data.frame</code>s for batch processing.</p>
<ul>
<li>
<code>WORKER_UP</code>
<ul>
<li><code>DO_SETUP</code></li>
</ul>
</li>
<li>
<code>WORKER_READY</code> <em>[repeat]</em>
<ul>
<li>
<code>DO_CHUNK</code> <em>[repeat]</em>
</li>
</ul>
</li>
<li>
<code>WORKER_READY</code>
<ul>
<li><code>WORKER_STOP</code></li>
</ul>
</li>
<li><code>WORKER_DONE</code></li>
</ul>
<p>These can be implemented the following way:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>w<span class="sc">$</span><span class="fu">set_common_data</span>(...)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span>(work remaining or w<span class="sc">$</span>workers_running <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    msg <span class="ot">=</span> w<span class="sc">$</span><span class="fu">receive_data</span>() <span class="co"># wait until a worker is ready</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (msg<span class="sc">$</span>id <span class="sc">==</span> <span class="st">"WORKER_UP"</span>) { <span class="co"># treat same as WORKER_READY if no common data</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>        w<span class="sc">$</span><span class="fu">send_common_data</span>()</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (msg<span class="sc">$</span>id <span class="sc">==</span> <span class="st">"WORKER_READY"</span>) {</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (work remaining)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>            w<span class="sc">$</span><span class="fu">send_job_data</span>(data.frame with arguments <span class="cf">for</span> all calls of this chunk)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>            w<span class="sc">$</span><span class="fu">send_shutdown_worker</span>()</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ..handle your result..</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (msg<span class="sc">$</span>id <span class="sc">==</span> <span class="st">"WORKER_DONE"</span>) {</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>        w<span class="sc">$</span><span class="fu">disconnect_worker</span>()</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (msg<span class="sc">$</span>id <span class="sc">==</span> <span class="st">"WORKER_ERROR"</span>) {</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"processing error"</span>)</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div class="section level4">
<h4 id="evaluating-custom-expressions">Evaluating custom expressions<a class="anchor" aria-label="anchor" href="#evaluating-custom-expressions"></a>
</h4>
<p>This can be mixed with batch processing, as long as <code>DO_SETUP</code> is called before <code>DO_CHUNK</code> (otherwise it will cause <code>WORKER_ERROR</code> on token mismatch).</p>
<ul>
<li>
<code>WORKER_UP</code>
<ul>
<li>
<code>DO_SETUP</code> or <code>DO_CALL</code> (e.g. to export commonly used data)</li>
</ul>
</li>
<li>
<code>WORKER_READY</code> <em>[repeat]</em>
<ul>
<li>
<code>DO_CALL</code> <em>[repeat]</em>
</li>
</ul>
</li>
<li>
<code>WORKER_READY</code>
<ul>
<li><code>WORKER_STOP</code></li>
</ul>
</li>
<li><code>WORKER_DONE</code></li>
</ul>
<p>These can be implemented the following way:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>w<span class="sc">$</span><span class="fu">set_common_data</span>(...) <span class="co"># optional, if common data required</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span>(work remaining or w<span class="sc">$</span>workers_running <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    msg <span class="ot">=</span> w<span class="sc">$</span><span class="fu">receive_data</span>() <span class="co"># wait until a worker is ready</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (msg<span class="sc">$</span>id <span class="sc">==</span> <span class="st">"WORKER_UP"</span>) { <span class="co"># treat same as WORKER_READY if no common data</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        w<span class="sc">$</span><span class="fu">send_common_data</span>()</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (msg<span class="sc">$</span>id <span class="sc">==</span> <span class="st">"WORKER_READY"</span>) {</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (work remaining)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>            w<span class="sc">$</span><span class="fu">send_call</span>(expr, env)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>            w<span class="sc">$</span><span class="fu">send_shutdown_worker</span>()</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ..handle your result..</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (msg<span class="sc">$</span>id <span class="sc">==</span> <span class="st">"WORKER_DONE"</span>) {</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        w<span class="sc">$</span><span class="fu">disconnect_worker</span>()</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (msg<span class="sc">$</span>id <span class="sc">==</span> <span class="st">"WORKER_ERROR"</span>) {</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">stop</span>(<span class="st">"processing error"</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Michael Schubert.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
