language: r

r:
 - release
 - devel

warnings_are_errors: true

cache: packages

before_install:
 - sed -i "1iexport PATH=\$PATH:$(dirname $(which R)):tests/bin" ~/.bashrc
 - sed -i "2iexport R_LIBS_USER=$R_LIBS_USER" ~/.bashrc
 - sudo apt-get install libzmq3-dev
 - ssh-keygen -t rsa -f ~/.ssh/id_rsa -N "" -q
 - cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
 - ssh-keyscan -t rsa localhost >> ~/.ssh/known_hosts
 - echo "Host localhost
    IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
 - echo "$(hostname) 127.0.0.1" >> ~/.hosts
 - echo $R_LIBS_USER
 - echo $R_LIBS_SITE

before_script:
 - pwd
 - source ~/.bashrc
 - echo $PATH
 - which R
 - which sbatch
 - R --no-save --no-restore -e "message(clustermq:::qsys_default)" > /dev/null
 - ping -c3 $(hostname)
 - ssh localhost 'exit'
 - ssh localhost 'R --no-save --no-restore -e "quit()" > /dev/null'

script:
 - R CMD build .
 - R CMD INSTALL *.tar.gz
 - ssh localhost 'R --no-save --no-restore -e "message(clustermq:::qsys_default)" > /dev/null'
 - make test
# - make check
 - R CMD check --as-cran *.tar.gz

after_failure:
 - cat ~/*.log
